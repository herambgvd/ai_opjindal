{% extends "cross_counting/analysis/base.html" %}
{% load static %}

{% block title %}Daily Analysis{% endblock title %}

{% block analysis_form %}
    <form method="get" class="row g-3">
        <div class="col-md-6">
            <label for="{{ form.region.id_for_label }}" class="form-label">Region</label>
            {{ form.region }}
            {% if form.region.errors %}
                <div class="invalid-feedback d-block">{{ form.region.errors.0 }}</div>
            {% endif %}
        </div>
        <div class="col-md-4">
            <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
            {{ form.date }}
            {% if form.date.errors %}
                <div class="invalid-feedback d-block">{{ form.date.errors.0 }}</div>
            {% endif %}
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="btn btn-primary d-block w-100 mb-2">
                <i class="bx bx-search"></i> Analyze
            </button>
            {% if analysis_data %}
                <a href="{% url 'cross_counting:daily_analysis_csv' %}?{{ request.GET.urlencode }}"
                   class="btn btn-success d-block w-100">
                    <i class="bx bx-download"></i> Export CSV
                </a>
            {% endif %}
        </div>
    </form>
{% endblock %}

{% block analysis_results %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-truncate font-size-14 mb-2">Daily Entries</p>
                            <h4 class="mb-2">{{ analysis_data.summary.total_daily_entries|default:0 }}</h4>
                            <small>People entered today</small>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="mdi mdi-arrow-down-bold font-size-24"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-truncate font-size-14 mb-2">Daily Exits</p>
                            <h4 class="mb-2">{{ analysis_data.summary.total_daily_exits|default:0 }}</h4>
                            <small>People exited today</small>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="mdi mdi-arrow-up-bold font-size-24"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-truncate font-size-14 mb-2">Net Change</p>
                            <h4 class="mb-2">
                                {% if analysis_data.summary.net_daily_change >= 0 %}
                                    +{{ analysis_data.summary.net_daily_change|default:0 }}
                                {% else %}
                                    {{ analysis_data.summary.net_daily_change|default:0 }}
                                {% endif %}
                            </h4>
                            <small>Net occupancy change</small>
                        </div>
                        <div class="flex-shrink-0">
                            {% if analysis_data.summary.net_daily_change >= 0 %}
                                <i class="mdi mdi-trending-up font-size-24"></i>
                            {% else %}
                                <i class="mdi mdi-trending-down font-size-24"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-truncate font-size-14 mb-2">Peak Occupancy</p>
                            <h4 class="mb-2">{{ analysis_data.summary.total_peak_occupancy|default:0 }}</h4>
                            <small>Maximum people present</small>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="mdi mdi-account-group font-size-24"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update the camera-wise table as well -->
    <div class="row">
        <div class="col-12">
            <h6>Camera-wise Daily Traffic Flow</h6>
            <table class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>Camera</th>
                    <th>Daily Entries</th>
                    <th>Daily Exits</th>
                    <th>Net Change</th>
                    <th>Peak Occupancy</th>
                    <th class="text-muted">Peak Cumulative In</th>
                    <th class="text-muted">Peak Cumulative Out</th>
                </tr>
                </thead>
                <tbody>
                {% for camera in analysis_data.cameras %}
                    <tr>
                        <td><strong>{{ camera.camera_name }}</strong></td>
                        <td class="text-success">{{ camera.daily_entries|default:0 }}</td>
                        <td class="text-danger">{{ camera.daily_exits|default:0 }}</td>
                        <td class="{% if camera.net_daily_change >= 0 %}text-success{% else %}text-warning{% endif %}">
                            {% if camera.net_daily_change >= 0 %}+{% endif %}{{ camera.net_daily_change|default:0 }}
                        </td>
                        <td class="text-info">{{ camera.peak_occupancy|default:0 }}</td>
                        <td class="text-muted small">{{ camera.peak_cumulative_in|default:0 }}</td>
                        <td class="text-muted small">{{ camera.peak_cumulative_out|default:0 }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block analysis_js %}
    <script>
        // Region Hourly Chart - NOW SHOWS TRAFFIC FLOW (entries/exits per hour)
        {% if analysis_data.region_hourly_aggregates and analysis_data.region_hourly_aggregates.hourly_data %}
            var regionInData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            var regionOutData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            var occupancyChangeData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            // Populate traffic flow data (entries/exits per hour, not cumulative)
            {% for hour_data in analysis_data.region_hourly_aggregates.hourly_data %}
                regionInData[{{ hour_data.hour }}] = {{ hour_data.total_in_count|default:0 }};
                regionOutData[{{ hour_data.hour }}] = {{ hour_data.total_out_count|default:0 }};
                occupancyChangeData[{{ hour_data.hour }}] = {{ hour_data.net_occupancy_change|default:0 }};
            {% endfor %}

            var regionOptions = {
                series: [{
                    name: 'Hourly Entries',
                    data: regionInData,
                    color: '#28a745',
                    type: 'column'
                }, {
                    name: 'Hourly Exits',
                    data: regionOutData,
                    color: '#dc3545',
                    type: 'column'
                }, {
                    name: 'Net Occupancy Change',
                    data: occupancyChangeData,
                    color: '#007bff',
                    type: 'line'
                }],
                chart: {
                    type: 'line',
                    height: 400,
                    toolbar: {show: true}
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '70%',
                        endingShape: 'rounded'
                    }
                },
                xaxis: {
                    categories: [
                        '00:00', '01:00', '02:00', '03:00', '04:00', '05:00',
                        '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
                        '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
                        '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
                    ],
                    title: {
                        text: 'Hour (24-hour format)',
                        style: {fontSize: '14px', fontWeight: 600}
                    },
                    labels: {rotate: -45}
                },
                yaxis: {
                    title: {
                        text: 'People Count (Entries/Exits per Hour)',
                        style: {fontSize: '14px', fontWeight: 600}
                    },
                    min: 0
                },
                title: {
                    text: 'Hourly Traffic Flow - {{ analysis_data.date }} (Entries/Exits per Hour)',
                    align: 'center',
                    style: {fontSize: '16px', fontWeight: 600}
                },
                stroke: {
                    curve: 'smooth',
                    width: [0, 0, 3]  // No stroke for columns, 3px for line
                },
                markers: {size: [0, 0, 5]},  // No markers for columns, 5px for line
                legend: {position: 'top', horizontalAlign: 'center'},
                grid: {borderColor: '#e7e7e7', strokeDashArray: 5},
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (opts.seriesIndex === 2) {
                                return val > 0 ? `+${val} net increase` : `${val} net decrease`;
                            }
                            return val + " people";
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                }
            };

            var regionChart = new ApexCharts(document.querySelector("#region_hourly_chart"), regionOptions);
            regionChart.render();
        {% else %}
            document.querySelector("#region_hourly_chart").innerHTML = '<div class="alert alert-info">No hourly traffic flow data available.</div>';
        {% endif %}

        // Individual Camera Chart - NOW SHOWS TRAFFIC FLOW
        {% if analysis_data.region_hourly_aggregates and analysis_data.region_hourly_aggregates.individual_camera_data %}
            var cameraSeries = [];
            var colors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14'];
            var colorIndex = 0;

            {% for camera in analysis_data.region_hourly_aggregates.individual_camera_data %}
                // Initialize arrays for this camera
                var inData_{{ forloop.counter0 }} = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                var outData_{{ forloop.counter0 }} = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

                // Populate hourly traffic flow data for this camera
                {% for hour_data in camera.hourly_data %}
                    inData_{{ forloop.parentloop.counter0 }}[{{ hour_data.hour }}] = {{ hour_data.cc_in_count|default:0 }};
                    outData_{{ forloop.parentloop.counter0 }}[{{ hour_data.hour }}] = {{ hour_data.cc_out_count|default:0 }};
                {% endfor %}

                // Add series for this camera (only if there's any data)
                var hasData = inData_{{ forloop.counter0 }}.some(val => val > 0) || outData_{{ forloop.counter0 }}.some(val => val > 0);
                if (hasData) {
                    cameraSeries.push({
                        name: '{{ camera.camera_name }} - Entries',
                        data: inData_{{ forloop.counter0 }},
                        color: colors[{{ forloop.counter0 }} % colors.length],
                        type: 'area'
                    });

                    cameraSeries.push({
                        name: '{{ camera.camera_name }} - Exits',
                        data: outData_{{ forloop.counter0 }},
                        color: colors[{{ forloop.counter0 }} % colors.length],
                        type: 'area',
                        fill: {
                            opacity: 0.3
                        }
                    });
                }
            {% endfor %}

            if (cameraSeries.length > 0) {
                var individualCameraOptions = {
                    series: cameraSeries,
                    chart: {
                        type: 'area',
                        height: 500,
                        toolbar: {show: true},
                        stacked: false
                    },
                    xaxis: {
                        categories: [
                            '00:00', '01:00', '02:00', '03:00', '04:00', '05:00',
                            '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
                            '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
                            '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
                        ],
                        title: {
                            text: 'Hour (24-hour format)',
                            style: {fontSize: '14px', fontWeight: 600}
                        },
                        labels: {rotate: -45}
                    },
                    yaxis: {
                        title: {
                            text: 'People Count (Entries/Exits per Hour)',
                            style: {fontSize: '14px', fontWeight: 600}
                        },
                        min: 0
                    },
                    title: {
                        text: 'Individual Camera Traffic Flow - {{ analysis_data.date }}',
                        align: 'center',
                        style: {fontSize: '16px', fontWeight: 600}
                    },
                    stroke: {curve: 'smooth', width: 2},
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.6,
                            opacityTo: 0.1,
                            stops: [0, 90, 100]
                        }
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'center',
                        fontSize: '12px'
                    },
                    grid: {borderColor: '#e7e7e7', strokeDashArray: 3},
                    tooltip: {
                        y: {
                            formatter: function (val) {
                                return val + " people per hour"
                            }
                        }
                    }
                };

                var individualCameraChart = new ApexCharts(document.querySelector("#individual_camera_chart"), individualCameraOptions);
                individualCameraChart.render();
            } else {
                document.querySelector("#individual_camera_chart").innerHTML = '<div class="alert alert-info">No camera traffic flow data available.</div>';
            }
        {% else %}
            document.querySelector("#individual_camera_chart").innerHTML = '<div class="alert alert-info">No camera data available.</div>';
        {% endif %}
    </script>
{% endblock %}