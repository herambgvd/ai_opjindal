{% extends "cross_counting/analysis/base.html" %}
{% load static %}

{% block title %}Daily Analysis{% endblock title %}

{% block analysis_form %}
    <form method="get" class="row g-3">
        <div class="col-md-6">
            <label for="{{ form.region.id_for_label }}" class="form-label">Region</label>
            {{ form.region }}
            {% if form.region.errors %}
                <div class="invalid-feedback d-block">{{ form.region.errors.0 }}</div>
            {% endif %}
        </div>
        <div class="col-md-4">
            <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
            {{ form.date }}
            {% if form.date.errors %}
                <div class="invalid-feedback d-block">{{ form.date.errors.0 }}</div>
            {% endif %}
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="btn btn-primary d-block w-100 mb-2">
                <i class="bx bx-search"></i> Analyze
            </button>
            {% if analysis_data %}
                <a href="{% url 'cross_counting:daily_analysis_csv' %}?{{ request.GET.urlencode }}"
                   class="btn btn-success d-block w-100">
                    <i class="bx bx-download"></i> Export CSV
                </a>
            {% endif %}
        </div>
    </form>
{% endblock %}

{% block analysis_results %}
    <!-- Summary Statistics Card -->
    {% if analysis_data.region_hourly_aggregates.daily_summary %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Daily Analysis Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h5 class="text-success">{{ analysis_data.region_hourly_aggregates.daily_summary.max_regional_occupancy }}</h5>
                                    <p class="mb-0 small">Peak Regional Occupancy</p>
                                    <small class="text-muted">Maximum people in all areas combined</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h5 class="text-info">{{ analysis_data.region_hourly_aggregates.daily_summary.peak_occupancy_hour }}:00</h5>
                                    <p class="mb-0 small">Peak Occupancy Hour</p>
                                    <small class="text-muted">Busiest time of day</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border-end">
                                    <h5 class="text-primary">{{ analysis_data.region_hourly_aggregates.daily_summary.active_cameras }}</h5>
                                    <p class="mb-0 small">Active Cameras</p>
                                    <small class="text-muted">Cameras with data</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border-end">
                                    <h5 class="text-warning">{{ analysis_data.region_hourly_aggregates.daily_summary.active_hours }}</h5>
                                    <p class="mb-0 small">Active Hours</p>
                                    <small class="text-muted">Hours with activity</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <h5 class="text-secondary">{{ analysis_data.region_hourly_aggregates.daily_summary.total_cameras_monitored }}</h5>
                                <p class="mb-0 small">Total Cameras</p>
                                <small class="text-muted">All cameras in region</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Regional Hourly Analysis</h6>
                    <p class="text-muted mb-0">Last value per hour from each camera, summed for regional totals</p>
                </div>
                <div class="card-body">
                    <div id="regional_hourly_chart"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Individual Camera Data</h6>
                    <p class="text-muted mb-0">All data points plotted as simple line charts (In count and Out
                        count)</p>
                </div>
                <div class="card-body">
                    <div id="individual_cameras_chart"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block analysis_js %}
    <script>
        // IMPROVED: Enhanced chart configurations for better visualization

        // Define hours array first
        var hours = ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'];

        // 1. REGIONAL HOURLY CHART - Now shows cumulative increasing pattern
        {% if analysis_data.simplified_analysis.regional_hourly_data %}
            var regionalInData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            var regionalOutData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            var occupancyData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            {% for hour_data in analysis_data.simplified_analysis.regional_hourly_data %}
                regionalInData[{{ hour_data.hour }}] = {{ hour_data.total_in_count|default:0 }};
                regionalOutData[{{ hour_data.hour }}] = {{ hour_data.total_out_count|default:0 }};
                occupancyData[{{ hour_data.hour }}] = {{ hour_data.current_occupancy|default:0 }};
            {% endfor %}

            var regionalOptions = {
                series: [{
                    name: 'Regional Total In (Cumulative)',
                    data: regionalInData,
                    color: '#28a745',
                    type: 'line'
                }, {
                    name: 'Regional Total Out (Cumulative)',
                    data: regionalOutData,
                    color: '#dc3545',
                    type: 'line'
                }, {
                    name: 'Current Occupancy',
                    data: occupancyData,
                    color: '#007bff',
                    type: 'area'
                }],
                chart: {
                    type: 'line',
                    height: 450,  // Increased height
                    toolbar: {show: true},
                    zoom: {enabled: true}
                },
                xaxis: {
                    categories: hours,
                    title: {
                        text: 'Hour (24-hour format)',
                        style: {fontSize: '14px', fontWeight: 600}
                    },
                    labels: {rotate: -45}
                },
                yaxis: {
                    title: {
                        text: 'Cumulative Count',
                        style: {fontSize: '14px', fontWeight: 600}
                    },
                    min: 0
                },
                title: {
                    text: 'Regional Hourly Totals (Cumulative with Carry-Forward) - {{ analysis_data.analysis_date }}',
                    align: 'center',
                    style: {fontSize: '16px', fontWeight: 600}
                },
                stroke: {
                    curve: 'smooth',
                    width: [4, 4, 2]  // Thicker lines for better visibility
                },
                fill: {
                    type: ['solid', 'solid', 'gradient'],
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.4,
                        opacityTo: 0.1
                    }
                },
                markers: {
                    size: [5, 5, 0],  // Larger markers
                    strokeWidth: 2
                },
                legend: {
                    position: 'top',
                    fontSize: '13px'
                },
                grid: {
                    borderColor: '#e7e7e7',
                    strokeDashArray: 3
                },
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (opts.seriesIndex === 2) {
                                return val + " people currently";
                            }
                            return val + " total cumulative count";
                        }
                    }
                },
                annotations: {
                    xaxis: [{
                        x: '12:00',
                        borderColor: '#00E396',
                        label: {
                            borderColor: '#00E396',
                            style: {
                                color: '#fff',
                                background: '#00E396',
                            },
                            text: 'Data starts'
                        }
                    }]
                }
            };

            var regionalChart = new ApexCharts(document.querySelector("#regional_hourly_chart"), regionalOptions);
            regionalChart.render();
        {% endif %}

        // 2. IMPROVED INDIVIDUAL CAMERA CHARTS - Better organization and visualization
        {% if analysis_data.simplified_analysis.individual_camera_data %}
            var colors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14', '#20c997', '#6610f2'];
            var cameraInSeries = [];
            var cameraOutSeries = [];

            {% for camera in analysis_data.simplified_analysis.individual_camera_data %}
                {% if camera.data_points %}
                    // Prepare time series data for {{ camera.camera_name }}
                    var cameraInData_{{ forloop.counter0 }} = [];
                    var cameraOutData_{{ forloop.counter0 }} = [];

                    {% for point in camera.data_points %}
                        cameraInData_{{ forloop.parentloop.counter0 }}.push({
                            x: {{ forloop.counter0 }},  // Use index as X
                            y: {{ point.cc_in_count }},
                            timestamp: '{{ point.created_at }}'
                        });
                        cameraOutData_{{ forloop.parentloop.counter0 }}.push({
                            x: {{ forloop.counter0 }},  // Use index as X
                            y: {{ point.cc_out_count }},
                            timestamp: '{{ point.created_at }}'
                        });
                    {% endfor %}

                    // Add In count series
                    cameraInSeries.push({
                        name: '{{ camera.camera_name }} - In',
                        data: cameraInData_{{ forloop.counter0 }},
                        color: colors[{{ forloop.counter0 }} % colors.length],
                        type: 'line'
                    });

                    // Add Out count series with dashed line
                    cameraOutSeries.push({
                        name: '{{ camera.camera_name }} - Out',
                        data: cameraOutData_{{ forloop.counter0 }},
                        color: colors[{{ forloop.counter0 }} % colors.length],
                        type: 'line'
                    });
                {% endif %}
            {% endfor %}

            // Combine all series
            var allCameraSeries = [...cameraInSeries, ...cameraOutSeries];

            if (allCameraSeries.length > 0) {
                var individualCameraOptions = {
                    series: allCameraSeries,
                    chart: {
                        type: 'line',
                        height: 700,  // Increased height for better visibility
                        toolbar: {
                            show: true,
                            tools: {
                                download: true,
                                selection: true,
                                zoom: true,
                                zoomin: true,
                                zoomout: true,
                                pan: true,
                                reset: true
                            }
                        },
                        zoom: {enabled: true}
                    },
                    xaxis: {
                        type: 'numeric',
                        title: {
                            text: 'Data Point Index (Chronological Order)',
                            style: {fontSize: '14px', fontWeight: 600}
                        },
                        labels: {
                            formatter: function (val) {
                                return Math.floor(val);
                            }
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'Cumulative Count',
                            style: {fontSize: '14px', fontWeight: 600}
                        },
                        min: 0
                    },
                    title: {
                        text: 'Individual Camera Data - All Points (Chronological) - {{ analysis_data.analysis_date }}',
                        align: 'center',
                        style: {fontSize: '16px', fontWeight: 600}
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 2
                    },
                    markers: {
                        size: 0  // No markers for cleaner lines
                    },
                    legend: {
                        position: 'top',
                        fontSize: '11px',
                        markers: {width: 12, height: 12},
                        itemMargin: {horizontal: 8}
                    },
                    grid: {
                        borderColor: '#e7e7e7',
                        strokeDashArray: 3
                    },
                    tooltip: {
                        shared: false,
                        intersect: false,
                        x: {
                            formatter: function (val) {
                                return "Point " + Math.floor(val);
                            }
                        },
                        y: {
                            formatter: function (val, opts) {
                                var seriesName = opts.series[opts.seriesIndex].name;
                                var dataPoint = opts.series[opts.seriesIndex].data[opts.dataPointIndex];
                                if (dataPoint && dataPoint.timestamp) {
                                    return val + " count at " + dataPoint.timestamp;
                                }
                                return val + " count";
                            }
                        }
                    },
                    dataLabels: {
                        enabled: false
                    }
                };

                var individualChart = new ApexCharts(document.querySelector("#individual_cameras_chart"), individualCameraOptions);
                individualChart.render();
            } else {
                document.querySelector("#individual_cameras_chart").innerHTML = '<div class="alert alert-info">No individual camera data available.</div>';
            }
        {% endif %}
    </script>
{% endblock %}