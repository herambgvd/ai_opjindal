{% extends "cross_counting/analysis/base.html" %}
{% load static %}

{% block title %}Daily Analysis{% endblock title %}

{% block analysis_form %}
    <form method="get" class="row g-3">
        <div class="col-md-6">
            <label for="{{ form.region.id_for_label }}" class="form-label">Region</label>
            {{ form.region }}
            {% if form.region.errors %}
                <div class="invalid-feedback d-block">{{ form.region.errors.0 }}</div>
            {% endif %}
        </div>
        <div class="col-md-4">
            <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
            {{ form.date }}
            {% if form.date.errors %}
                <div class="invalid-feedback d-block">{{ form.date.errors.0 }}</div>
            {% endif %}
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="btn btn-primary d-block w-100 mb-2">
                <i class="bx bx-search"></i> Analyze
            </button>
            {% if analysis_data %}
                <a href="{% url 'cross_counting:daily_analysis_csv' %}?{{ request.GET.urlencode }}"
                   class="btn btn-success d-block w-100">
                    <i class="bx bx-download"></i> Export CSV
                </a>
            {% endif %}
        </div>
    </form>
{% endblock %}

{% block analysis_results %}
    <!-- Replace the charts section in your daily.html template -->

    <div class="row mt-4">
        <div class="col-12">
            <h6>Regional Hourly Cumulative Analysis</h6>
            <p class="text-muted">Shows cumulative in/out counts and current occupancy levels throughout the day</p>
            <div id="region_hourly_chart"></div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <h6>Individual Camera Cumulative Trends</h6>
            <p class="text-muted">Shows each camera's cumulative counts progression (solid line = in, dashed line =
                out)</p>
            <div id="individual_camera_chart"></div>
        </div>
    </div>

    <!-- Summary Statistics Card -->
    {% if analysis_data.region_hourly_aggregates.daily_summary %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Daily Analysis Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h5 class="text-success">{{ analysis_data.region_hourly_aggregates.daily_summary.max_regional_occupancy }}</h5>
                                    <p class="mb-0 small">Peak Regional Occupancy</p>
                                    <small class="text-muted">Maximum people in all areas combined</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h5 class="text-info">{{ analysis_data.region_hourly_aggregates.daily_summary.peak_occupancy_hour }}:00</h5>
                                    <p class="mb-0 small">Peak Occupancy Hour</p>
                                    <small class="text-muted">Busiest time of day</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border-end">
                                    <h5 class="text-primary">{{ analysis_data.region_hourly_aggregates.daily_summary.active_cameras }}</h5>
                                    <p class="mb-0 small">Active Cameras</p>
                                    <small class="text-muted">Cameras with data</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border-end">
                                    <h5 class="text-warning">{{ analysis_data.region_hourly_aggregates.daily_summary.active_hours }}</h5>
                                    <p class="mb-0 small">Active Hours</p>
                                    <small class="text-muted">Hours with activity</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <h5 class="text-secondary">{{ analysis_data.region_hourly_aggregates.daily_summary.total_cameras_monitored }}</h5>
                                <p class="mb-0 small">Total Cameras</p>
                                <small class="text-muted">All cameras in region</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Camera-wise Summary Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Camera-wise Daily Summary</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th>Camera</th>
                                <th>Max Cumulative In</th>
                                <th>Max Cumulative Out</th>
                                <th>Peak Occupancy</th>
                                <th>Active Hours</th>
                                <th>Status</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for camera in analysis_data.region_hourly_aggregates.individual_camera_data %}
                                <tr>
                                    <td><strong>{{ camera.camera_name }}</strong></td>
                                    <td class="text-success">{{ camera.daily_stats.max_cumulative_in }}</td>
                                    <td class="text-danger">{{ camera.daily_stats.max_cumulative_out }}</td>
                                    <td class="text-info">{{ camera.daily_stats.max_occupancy }}</td>
                                    <td class="text-warning">{{ camera.daily_stats.active_hours }}</td>
                                    <td>
                                        {% if camera.daily_stats.max_cumulative_in > 0 %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">No Data</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No camera data available
                                        for {{ analysis_data.date }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block analysis_js %}
    <script>
        {% if analysis_data.region_hourly_aggregates and analysis_data.region_hourly_aggregates.hourly_data %}
            // Prepare data arrays for cumulative display
            var hours = ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'];

            // Regional cumulative data (sum of all cameras)
            var regionalInData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            var regionalOutData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            var occupancyData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            {% for hour_data in analysis_data.region_hourly_aggregates.hourly_data %}
                regionalInData[{{ hour_data.hour }}] = {{ hour_data.total_in_count|default:0 }};
                regionalOutData[{{ hour_data.hour }}] = {{ hour_data.total_out_count|default:0 }};
                occupancyData[{{ hour_data.hour }}] = {{ hour_data.current_occupancy|default:0 }};
            {% endfor %}

            // 1. REGIONAL CUMULATIVE CHART
            var regionalOptions = {
                series: [{
                    name: 'Total In Count',
                    data: regionalInData,
                    color: '#28a745',
                    type: 'line'
                }, {
                    name: 'Total Out Count',
                    data: regionalOutData,
                    color: '#dc3545',
                    type: 'line'
                }, {
                    name: 'Current Occupancy',
                    data: occupancyData,
                    color: '#007bff',
                    type: 'area'
                }],
                chart: {
                    type: 'line',
                    height: 450,
                    toolbar: {show: true}
                },
                xaxis: {
                    categories: hours,
                    title: {
                        text: 'Hour (24-hour format)',
                        style: {fontSize: '14px', fontWeight: 600}
                    },
                    labels: {rotate: -45}
                },
                yaxis: {
                    title: {
                        text: 'Cumulative Count',
                        style: {fontSize: '14px', fontWeight: 600}
                    },
                    min: 0
                },
                title: {
                    text: 'Regional Hourly Cumulative Counts & Occupancy - {{ analysis_data.date }}',
                    align: 'center',
                    style: {fontSize: '16px', fontWeight: 600}
                },
                stroke: {
                    curve: 'smooth',
                    width: [3, 3, 2]
                },
                fill: {
                    type: ['solid', 'solid', 'gradient'],
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.4,
                        opacityTo: 0.1,
                        stops: [0, 90, 100]
                    }
                },
                markers: {size: [4, 4, 0]},
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                },
                grid: {
                    borderColor: '#e7e7e7',
                    strokeDashArray: 3
                },
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (opts.seriesIndex === 2) {
                                return val + " people currently in space";
                            }
                            return val + " total count";
                        }
                    }
                },
                annotations: {
                    yaxis: [{
                        y: Math.max(...occupancyData),
                        borderColor: '#007bff',
                        label: {
                            borderColor: '#007bff',
                            style: {
                                color: '#fff',
                                background: '#007bff'
                            },
                            text: 'Peak Occupancy: ' + Math.max(...occupancyData)
                        }
                    }]
                }
            };

            var regionalChart = new ApexCharts(document.querySelector("#region_hourly_chart"), regionalOptions);
            regionalChart.render();

            // 2. INDIVIDUAL CAMERA CHARTS
            {% if analysis_data.region_hourly_aggregates.individual_camera_data %}
                var colors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14', '#20c997', '#6610f2'];

                // Camera series for cumulative display
                var cameraCumulativeSeries = [];
                var cameraOccupancySeries = [];

                {% for camera in analysis_data.region_hourly_aggregates.individual_camera_data %}
                    // Initialize arrays for this camera
                    var cameraInData_{{ forloop.counter0 }} = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    var cameraOutData_{{ forloop.counter0 }} = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    var cameraOccupancy_{{ forloop.counter0 }} = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

                    // Populate hourly data for this camera
                    {% for hour_data in camera.hourly_data %}
                        cameraInData_{{ forloop.parentloop.counter0 }}[{{ hour_data.hour }}] = {{ hour_data.cc_in_count|default:0 }};
                        cameraOutData_{{ forloop.parentloop.counter0 }}[{{ hour_data.hour }}] = {{ hour_data.cc_out_count|default:0 }};
                        cameraOccupancy_{{ forloop.parentloop.counter0 }}[{{ hour_data.hour }}] = {{ hour_data.current_occupancy|default:0 }};
                    {% endfor %}

                    // Only add camera if it has data
                    var hasData = cameraInData_{{ forloop.counter0 }}.some(val => val > 0) || cameraOutData_{{ forloop.counter0 }}.some(val => val > 0);
                    if (hasData) {
                        // Cumulative counts
                        cameraCumulativeSeries.push({
                            name: '{{ camera.camera_name }} - In',
                            data: cameraInData_{{ forloop.counter0 }},
                            color: colors[{{ forloop.counter0 }} % colors.length],
                            stroke: {width: 2}
                        });

                        cameraCumulativeSeries.push({
                            name: '{{ camera.camera_name }} - Out',
                            data: cameraOutData_{{ forloop.counter0 }},
                            color: colors[{{ forloop.counter0 }} % colors.length],
                            stroke: {width: 2, dashArray: 5}
                        });

                        // Occupancy levels
                        cameraOccupancySeries.push({
                            name: '{{ camera.camera_name }}',
                            data: cameraOccupancy_{{ forloop.counter0 }},
                            color: colors[{{ forloop.counter0 }} % colors.length]
                        });
                    }
                {% endfor %}

                // Individual Camera Cumulative Chart
                if (cameraCumulativeSeries.length > 0) {
                    var individualCumulativeOptions = {
                        series: cameraCumulativeSeries,
                        chart: {
                            type: 'line',
                            height: 500,
                            toolbar: {show: true}
                        },
                        xaxis: {
                            categories: hours,
                            title: {
                                text: 'Hour (24-hour format)',
                                style: {fontSize: '14px', fontWeight: 600}
                            },
                            labels: {rotate: -45}
                        },
                        yaxis: {
                            title: {
                                text: 'Cumulative Count',
                                style: {fontSize: '14px', fontWeight: 600}
                            },
                            min: 0
                        },
                        title: {
                            text: 'Individual Camera Cumulative Counts - {{ analysis_data.date }}',
                            align: 'center',
                            style: {fontSize: '16px', fontWeight: 600}
                        },
                        stroke: {curve: 'smooth', width: 2},
                        markers: {size: 3},
                        legend: {
                            position: 'top',
                            horizontalAlign: 'center',
                            fontSize: '11px',
                            markers: {
                                width: 8,
                                height: 8
                            }
                        },
                        grid: {borderColor: '#e7e7e7', strokeDashArray: 3},
                        tooltip: {
                            y: {
                                formatter: function (val) {
                                    return val + " cumulative count";
                                }
                            }
                        }
                    };

                    var individualCumulativeChart = new ApexCharts(document.querySelector("#individual_camera_chart"), individualCumulativeOptions);
                    individualCumulativeChart.render();
                } else {
                    document.querySelector("#individual_camera_chart").innerHTML = '<div class="alert alert-info">No individual camera data available for {{ analysis_data.date }}.</div>';
                }

                // Camera Occupancy Chart (as secondary analysis)
                if (cameraOccupancySeries.length > 0) {
                    // Add a toggle to switch between cumulative and occupancy view
                    var occupancyChartHtml = `
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Individual Camera Occupancy Levels</h6>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleOccupancyChart()">
                            Show Occupancy View
                        </button>
                    </div>
                    <div id="individual_occupancy_chart" style="display: none;"></div>
                </div>
            `;

                    document.querySelector("#individual_camera_chart").insertAdjacentHTML('afterend', occupancyChartHtml);

                    window.toggleOccupancyChart = function () {
                        var occupancyDiv = document.getElementById('individual_occupancy_chart');
                        var button = event.target;

                        if (occupancyDiv.style.display === 'none') {
                            occupancyDiv.style.display = 'block';
                            button.textContent = 'Hide Occupancy View';

                            // Render occupancy chart if not already rendered
                            if (!window.occupancyChartRendered) {
                                var occupancyOptions = {
                                    series: cameraOccupancySeries,
                                    chart: {
                                        type: 'area',
                                        height: 400,
                                        toolbar: {show: true}
                                    },
                                    xaxis: {
                                        categories: hours,
                                        title: {text: 'Hour (24-hour format)'},
                                        labels: {rotate: -45}
                                    },
                                    yaxis: {
                                        title: {text: 'Current Occupancy (People in Space)'},
                                        min: 0
                                    },
                                    title: {
                                        text: 'Individual Camera Occupancy Levels - {{ analysis_data.date }}',
                                        align: 'center'
                                    },
                                    stroke: {curve: 'smooth', width: 2},
                                    fill: {
                                        type: 'gradient',
                                        gradient: {
                                            shadeIntensity: 1,
                                            opacityFrom: 0.6,
                                            opacityTo: 0.1
                                        }
                                    },
                                    legend: {position: 'top', fontSize: '11px'},
                                    tooltip: {
                                        y: {
                                            formatter: function (val) {
                                                return val + " people";
                                            }
                                        }
                                    }
                                };

                                var occupancyChart = new ApexCharts(document.querySelector("#individual_occupancy_chart"), occupancyOptions);
                                occupancyChart.render();
                                window.occupancyChartRendered = true;
                            }
                        } else {
                            occupancyDiv.style.display = 'none';
                            button.textContent = 'Show Occupancy View';
                        }
                    };
                }
            {% endif %}

        {% else %}
            document.querySelector("#region_hourly_chart").innerHTML = '<div class="alert alert-info">No hourly data available for {{ analysis_data.date }}.</div>';
            document.querySelector("#individual_camera_chart").innerHTML = '<div class="alert alert-info">No camera data available for {{ analysis_data.date }}.</div>';
        {% endif %}
    </script>
{% endblock %}